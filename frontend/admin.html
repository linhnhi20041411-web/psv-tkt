<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CMS Quản Trị - Pháp Môn Tâm Linh</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <style>
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow-x: hidden; overflow-y: visible !important; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans">

    <div id="loginOverlay" class="fixed inset-0 bg-gray-900 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full text-center">
            <div class="mb-4 text-amber-600 text-5xl"><i class="fas fa-user-shield"></i></div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Đăng Nhập Quản Trị</h2>
            <p class="text-gray-500 mb-6 text-sm">Vui lòng nhập mật khẩu Admin để truy cập hệ thống.</p>
            <input type="password" id="loginPass" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none mb-4 text-center text-lg" placeholder="••••••" onkeyup="if(event.key==='Enter') doLogin()">
            <button onclick="doLogin()" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-bold py-3 rounded-lg transition">Truy Cập Hệ Thống</button>
            <p id="loginError" class="text-red-500 text-sm mt-3 hidden"></p>
        </div>
    </div>

    <div class="container mx-auto p-4 max-w-6xl hidden" id="mainApp">
        <div class="bg-white rounded-xl shadow-lg overflow-hidden min-h-[80vh] flex flex-col">
            <div class="bg-amber-700 p-4 flex justify-between items-center text-white">
                <h1 class="font-bold text-xl"><i class="fas fa-cogs mr-2"></i> Hệ Thống Quản Trị Dữ Liệu AI</h1>
                <button onclick="logout()" class="text-amber-200 hover:text-white text-sm"><i class="fas fa-sign-out-alt"></i> Đăng xuất</button>
            </div>

            <div class="flex border-b border-gray-200 bg-gray-50 text-sm font-medium">
                <button onclick="switchTab('manage')" id="tabManage" class="flex-1 py-4 hover:bg-gray-100 text-amber-600 border-b-2 border-amber-600"><i class="fas fa-edit mr-1"></i> Quản Lý & Sửa</button>
                <button onclick="switchTab('auto')" id="tabAuto" class="flex-1 py-4 hover:bg-gray-100 text-gray-500"><i class="fas fa-sync mr-1"></i> Đồng Bộ Auto</button>
                <button onclick="switchTab('manual')" id="tabManual" class="flex-1 py-4 hover:bg-gray-100 text-gray-500"><i class="fas fa-plus mr-1"></i> Thêm Thủ Công</button>
                <button onclick="switchTab('maintain')" id="tabMaintain" class="flex-1 py-4 hover:bg-gray-100 text-gray-500"><i class="fas fa-tools mr-1"></i> Bảo Trì</button>
            </div>

            <div class="p-6 flex-1 overflow-y-auto">
                
                <div id="contentManage" class="space-y-4">
                    <div class="flex gap-2">
                        <input type="text" id="searchKeyword" placeholder="Tìm tiêu đề, nội dung hoặc URL..." class="flex-1 px-4 py-2 border rounded-lg focus:ring-1 focus:ring-amber-500">
                        <button onclick="searchPosts()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-bold"><i class="fas fa-search"></i> Tìm</button>
                    </div>
                    
                    <div class="overflow-x-auto border rounded-lg h-[500px] overflow-y-auto relative">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50 sticky top-0 z-10 shadow-sm">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase">ID</th>
                                    <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase">Tiêu Đề / Nội Dung</th>
                                    <th class="px-4 py-3 text-center text-xs font-bold text-gray-500 uppercase w-32">Thao Tác</th>
                                </tr>
                            </thead>
                            <tbody id="manageTableBody" class="bg-white divide-y divide-gray-200 text-sm">
                                <tr><td colspan="3" class="px-4 py-8 text-center text-gray-400">Nhập từ khóa để tìm kiếm...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="contentAuto" class="hidden space-y-6 max-w-2xl mx-auto text-center pt-10">
                    <div class="bg-amber-50 p-6 rounded-full inline-block w-24 h-24 flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-rss text-4xl text-amber-600"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800">Đồng bộ từ Blogger</h3>
                    <p class="text-gray-500">Hệ thống sẽ quét 100 bài mới nhất. Bài nào chưa có sẽ tự động thêm.</p>
                    <input type="hidden" id="blogUrl" value="https://timkhaithi.pmtl.site">
                    <button onclick="startSync()" id="btnSync" class="bg-amber-600 hover:bg-amber-700 text-white px-8 py-3 rounded-lg font-bold shadow-lg transform active:scale-95 transition">
                        <i class="fas fa-play mr-2"></i> Bắt Đầu Quét
                    </button>
                </div>

                <div id="contentManual" class="hidden space-y-4 max-w-3xl mx-auto">
                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">URL Bài Viết</label><input type="text" id="manualUrl" class="w-full px-4 py-2 border rounded-lg focus:ring-1 focus:ring-green-500"></div>
                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Tiêu Đề</label><input type="text" id="manualTitle" class="w-full px-4 py-2 border rounded-lg focus:ring-1 focus:ring-green-500"></div>
                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nội Dung</label><textarea id="manualContent" rows="10" class="w-full px-4 py-2 border rounded-lg focus:ring-1 focus:ring-green-500 font-mono text-sm"></textarea></div>
                    <button onclick="manualAdd()" id="btnManual" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg shadow-lg"><i class="fas fa-save mr-2"></i> Lưu Vào Database</button>
                </div>

                <div id="contentMaintain" class="hidden space-y-6">
                    <div class="bg-white border border-gray-200 p-4 rounded-lg shadow-sm">
                        <h3 class="font-bold text-gray-800 mb-2"><i class="fas fa-trash-alt text-red-500 mr-2"></i> Xóa theo Link</h3>
                        <div class="flex gap-2">
                            <input type="text" id="deleteUrl" placeholder="https://..." class="flex-1 px-3 py-2 border rounded">
                            <button onclick="deleteSinglePost()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded font-bold">Xóa</button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-red-50 border border-red-100 p-4 rounded-lg">
                            <h3 class="text-red-800 font-bold mb-2">1. Quét Link Hỏng</h3>
                            <p class="text-xs text-red-600 mb-2">Quét toàn bộ DB, xóa các link 404 hoặc Soft 404.</p>
                            <div class="flex gap-2 mb-2"><span class="text-xs pt-2">Bắt đầu từ:</span><input type="number" id="startIndex" value="0" class="w-20 px-2 py-1 border rounded text-sm"></div>
                            <button onclick="scanDeadLinks()" id="btnScan" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 rounded">Chạy Quét</button>
                        </div>
                        
                        <div class="bg-orange-50 border border-orange-100 p-4 rounded-lg">
                            <h3 class="text-orange-800 font-bold mb-2">2. Dọn Dẹp Trùng Lặp</h3>
                            <p class="text-xs text-orange-600 mb-4">Tự động phát hiện các đoạn dữ liệu giống hệt nhau (cùng URL, cùng nội dung) và giữ lại 1 bản duy nhất.</p>
                            <button onclick="removeDuplicates()" id="btnDedup" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 rounded"><i class="fas fa-copy mr-2"></i> Tìm & Xóa Trùng</button>
                        </div>
                    </div>
                </div>

                <div id="statusArea" class="mt-6 hidden">
                    <div class="bg-gray-800 text-green-400 text-xs p-4 rounded-lg h-40 overflow-y-auto font-mono whitespace-pre-wrap leading-relaxed shadow-inner" id="logs"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="editModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl h-[90vh] flex flex-col">
            <div class="bg-blue-600 p-4 rounded-t-xl flex justify-between items-center text-white">
                <h3 class="font-bold text-lg"><i class="fas fa-edit mr-2"></i> Chỉnh Sửa Bài Viết</h3>
                <button onclick="closeEditModal()" class="hover:text-gray-200"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="p-6 flex-1 overflow-y-auto space-y-4">
                <input type="hidden" id="editId">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Tiêu Đề</label>
                    <input type="text" id="editTitle" class="w-full px-4 py-2 border rounded-lg focus:ring-1 focus:ring-blue-500 font-bold text-gray-800">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nội Dung (Khi lưu sẽ tự động tính lại Vector)</label>
                    <textarea id="editContent" class="w-full h-96 p-4 border rounded-lg focus:ring-1 focus:ring-blue-500 font-mono text-sm leading-relaxed bg-gray-50"></textarea>
                </div>
            </div>
            <div class="p-4 border-t bg-gray-50 flex justify-end gap-3 rounded-b-xl">
                <button onclick="closeEditModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium">Hủy</button>
                <button onclick="saveEdit()" id="btnSaveEdit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-bold shadow">Lưu Thay Đổi</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "https://psv-tkt.onrender.com"; // Link server Render
        
        // --- 1. QUẢN LÝ PHIÊN ĐĂNG NHẬP ---
        function checkSession() {
            const pass = sessionStorage.getItem('adminPass');
            if (pass) {
                document.getElementById('loginOverlay').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
            }
        }
        
        async function doLogin() {
            const pass = document.getElementById('loginPass').value;
            const errorMsg = document.getElementById('loginError');
            
            try {
                const res = await fetch(`${API_URL}/api/admin/login`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ password: pass })
                });
                if (res.ok) {
                    sessionStorage.setItem('adminPass', pass);
                    checkSession();
                } else {
                    errorMsg.innerText = "Mật khẩu không đúng!";
                    errorMsg.classList.remove('hidden');
                }
            } catch (e) { errorMsg.innerText = "Lỗi kết nối Server!"; errorMsg.classList.remove('hidden'); }
        }

        function logout() {
            sessionStorage.removeItem('adminPass');
            location.reload();
        }

        function getPass() { return sessionStorage.getItem('adminPass'); }

        // --- 2. CÁC CHỨC NĂNG CHÍNH ---
        
        // Tìm kiếm bài viết để sửa
        async function searchPosts() {
            const keyword = document.getElementById('searchKeyword').value;
            if (!keyword) return alert("Nhập từ khóa!");
            
            const tbody = document.getElementById('manageTableBody');
            tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4">Đang tìm...</td></tr>';

            try {
                const res = await fetch(`${API_URL}/api/admin/search-posts`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ password: getPass(), keyword })
                });
                const json = await res.json();
                
                tbody.innerHTML = "";
                if (json.data.length === 0) { tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4">Không tìm thấy.</td></tr>'; return; }

                json.data.forEach(item => {
                    const title = item.metadata?.title || 'No Title';
                    const contentPreview = item.content.substring(0, 100) + "...";
                    const safeItem = encodeURIComponent(JSON.stringify(item));
                    const safeTitle = (item.metadata?.title || '').replace(/'/g, "\\'"); // Xử lý dấu nháy đơn
                    
                    tbody.innerHTML += `
                        <tr class="hover:bg-gray-50 border-b group">
                            <td class="px-4 py-3 text-gray-500 text-xs">#${item.id}</td>
                            <td class="px-4 py-3">
                                <div class="font-bold text-gray-800 text-sm mb-1">${title}</div>
                                <div class="text-xs text-gray-500 font-mono bg-gray-100 p-1 rounded truncate">${item.url}</div>
                                <div class="text-xs text-gray-600 mt-1 line-clamp-2">${contentPreview}</div>
                            </td>
                            <td class="px-4 py-3 text-center">
                                <div class="flex flex-col gap-2 opacity-100 sm:opacity-0 group-hover:opacity-100 transition">
                                    <button onclick="openEditModal('${safeItem}')" class="bg-blue-100 text-blue-700 px-3 py-1 rounded text-xs font-bold hover:bg-blue-200"><i class="fas fa-pen"></i> Sửa</button>
                                    
                                    <button onclick="deletePost(${item.id}, '${safeTitle}')" class="bg-red-100 text-red-700 px-3 py-1 rounded text-xs font-bold hover:bg-red-200"><i class="fas fa-trash"></i> Xóa</button>
                                </div>
                            </td>
                        </tr>`;
                });
            } catch (e) { alert(e.message); }
        }

        // Mở Modal Sửa
        function openEditModal(encodedItem) {
            const item = JSON.parse(decodeURIComponent(encodedItem));
            document.getElementById('editId').value = item.id;
            document.getElementById('editTitle').value = item.metadata?.title || "";
            
            let displayContent = item.content;
            const regex = /Tiêu đề:.*?\nNội dung:([\s\S]*)/;
            const match = item.content.match(regex);
            if (match && match[1]) displayContent = match[1].trim();

            document.getElementById('editContent').value = displayContent;
            document.getElementById('editModal').classList.remove('hidden');
        }

        function closeEditModal() { document.getElementById('editModal').classList.add('hidden'); }

        // Lưu sửa đổi
        async function saveEdit() {
            const id = document.getElementById('editId').value;
            const title = document.getElementById('editTitle').value;
            const content = document.getElementById('editContent').value;
            const btn = document.getElementById('btnSaveEdit');
            
            if(!confirm("Hệ thống sẽ tính toán lại Vector cho bài này. Bạn có chắc chắn?")) return;

            btn.disabled = true; btn.innerHTML = "⏳ Đang xử lý...";
            try {
                const res = await fetch(`${API_URL}/api/admin/update-post`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ password: getPass(), id, title, content })
                });
                const data = await res.json();
                if (data.success) {
                    alert("Cập nhật thành công!");
                    closeEditModal();
                    searchPosts(); // Refresh list
                } else { alert("Lỗi: " + data.error); }
            } catch(e) { alert("Lỗi mạng: " + e.message); }
            finally { btn.disabled = false; btn.innerHTML = "Lưu Thay Đổi"; }
        }

        // Xóa trùng lặp
        async function removeDuplicates() {
            if(!confirm("CẢNH BÁO: Thao tác này sẽ quét toàn bộ Database và xóa các bản ghi trùng lặp (Giống hệt URL và Nội dung). Quá trình này không thể hoàn tác.")) return;
            streamRequest(`${API_URL}/api/admin/remove-duplicates`, { password: getPass() }, 'btnDedup', '<i class="fas fa-copy mr-2"></i> Tìm & Xóa Trùng');
        }

        // --- CÁC HÀM TIỆN ÍCH CHUNG ---
        function log(msg) {
            const logBox = document.getElementById('logs');
            document.getElementById('statusArea').classList.remove('hidden');
            logBox.innerHTML += msg; logBox.scrollTop = logBox.scrollHeight;
        }

        async function streamRequest(url, body, btnId, defaultText) {
            const btn = document.getElementById(btnId);
            const originalText = btn.innerHTML;
            btn.disabled = true; btn.innerHTML = `⏳ Đang chạy...`;
            document.getElementById('statusArea').classList.remove('hidden');
            document.getElementById('logs').innerHTML = "> Bắt đầu tiến trình...\n";
            try {
                const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                while (true) { const { done, value } = await reader.read(); if (done) break; log(decoder.decode(value)); }
            } catch (error) { log(`❌ Lỗi kết nối: ${error.message}\n`); }
            finally { btn.disabled = false; btn.innerHTML = originalText; }
        }

        function switchTab(tab) {
            ['manage', 'auto', 'manual', 'maintain'].forEach(t => {
                const btn = document.getElementById('tab' + t.charAt(0).toUpperCase() + t.slice(1));
                const content = document.getElementById('content' + t.charAt(0).toUpperCase() + t.slice(1));
                btn.className = "flex-1 py-4 hover:bg-gray-100 text-gray-500 border-b-2 border-transparent transition";
                content.classList.add('hidden');
                
                if (t === tab) {
                    btn.className = "flex-1 py-4 hover:bg-gray-100 text-amber-600 border-b-2 border-amber-600 font-bold transition";
                    content.classList.remove('hidden');
                }
            });
        }
        
        // Hàm xóa và quét link chết (Dùng lại logic cũ nhưng lấy pass từ Session)
        async function deleteSinglePost(urlIn = null) {
            const url = urlIn || document.getElementById('deleteUrl').value;
            if(!url) return alert("Thiếu URL");
            if(!confirm("Xóa vĩnh viễn bài này?")) return;
            try {
                // Lưu ý: Đây là API xóa theo URL (delete-post trong server của bạn có hỗ trợ cả URL và ID tùy logic)
                // Nhưng trong server.js hiện tại, /api/admin/delete-post dùng ID. 
                // Nếu bạn muốn dùng hàm này cho ô nhập URL, bạn cần sửa server để hỗ trợ xóa theo URL.
                // Tạm thời, hàm này chỉ dùng cho ô nhập URL ở tab Bảo trì.
                alert("Chức năng xóa theo URL đang bảo trì. Vui lòng dùng chức năng Xóa trong tab Quản Lý.");
            } catch(e) { alert(e.message); }
        }

        async function scanDeadLinks() {
            const startIndex = parseInt(document.getElementById('startIndex').value) || 0;
            const btn = document.getElementById('btnScan');
            btn.disabled = true;
            try {
                log("> Đang tải danh sách URL...\n");
                const resList = await fetch(`${API_URL}/api/admin/get-all-urls`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ password: getPass() }) });
                const dataList = await resList.json();
                const total = dataList.urls.length;
                log(`> Tổng: ${total} links. Bắt đầu từ ${startIndex}...\n`);

                const batchSize = 20;
                for (let i = startIndex; i < total; i += batchSize) {
                    const batch = dataList.urls.slice(i, i + batchSize);
                    await fetch(`${API_URL}/api/admin/check-batch`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ password: getPass(), urls: batch }) });
                    log(`> Đã check ${Math.min(i+batchSize, total)}/${total}...\n`);
                }
                alert("Hoàn tất quy trình!");
            } catch(e) { log("Lỗi: " + e.message); }
            finally { btn.disabled = false; }
        }

        // --- HÀM XÓA BÀI VIẾT THEO ID (CHUẨN) ---
        async function deletePost(postId, postTitle) {
            if (!confirm(`⚠️ CẢNH BÁO:\nBạn có chắc chắn muốn xóa bài viết:\n"${postTitle}"\n\nHành động này không thể hoàn tác!`)) {
                return;
            }
            
            const password = window.adminPassword || sessionStorage.getItem('adminPass') || prompt("Nhập mật khẩu Admin:");
            if (!password) return;

            try {
                const response = await fetch(`${API_URL}/api/admin/delete-post`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        password: password,
                        id: postId,      
                        title: postTitle 
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    alert("✅ Đã xóa bài viết thành công!");
                    searchPosts(); // Refresh list
                } else {
                    alert(`❌ Lỗi: ${result.error || 'Không xóa được'}`);
                }
            } catch (error) {
                console.error("Lỗi xóa bài:", error);
                alert("❌ Lỗi kết nối Server! Vui lòng kiểm tra lại.");
            }
        }
        
        // Manual Add & Start Sync (Tự động lấy pass)
        async function manualAdd() {
            const url = document.getElementById('manualUrl').value;
            const title = document.getElementById('manualTitle').value;
            const content = document.getElementById('manualContent').value;
            if(!url || !title || !content) return alert("Thiếu thông tin");
            streamRequest(`${API_URL}/api/admin/manual-add`, {password: getPass(), url, title, content}, 'btnManual', 'Lưu');
        }
        
        function startSync() {
            streamRequest(`${API_URL}/api/admin/sync-blogger`, {password: getPass(), blogUrl: document.getElementById('blogUrl').value}, 'btnSync', 'Bắt đầu quét');
        }

        // Init
        checkSession();
    </script>
</body>
</html>
