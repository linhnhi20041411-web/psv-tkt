<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n Tr·ªã Vi√™n - ƒê·ªìng B·ªô D·ªØ Li·ªáu</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-4xl"> <h1 class="text-2xl font-bold text-gray-800 mb-2 text-center">‚öôÔ∏è Qu·∫£n L√Ω D·ªØ Li·ªáu AI</h1>
        
        <div class="flex border-b border-gray-200 mb-6 overflow-x-auto">
            <button onclick="switchTab('auto')" id="tabAuto" class="flex-1 py-3 px-4 text-center text-amber-600 border-b-2 border-amber-600 font-bold whitespace-nowrap">ƒê·ªìng B·ªô Blogger</button>
            <button onclick="switchTab('manual')" id="tabManual" class="flex-1 py-3 px-4 text-center text-gray-500 hover:text-amber-600 font-medium whitespace-nowrap">Th√™m Th·ªß C√¥ng</button>
            <button onclick="switchTab('check')" id="tabCheck" class="flex-1 py-3 px-4 text-center text-gray-500 hover:text-amber-600 font-medium whitespace-nowrap">üëÅÔ∏è Ki·ªÉm Tra D·ªØ Li·ªáu</button>
        </div>

        <div class="mb-4 max-w-md mx-auto">
            <label class="block text-sm font-medium text-gray-700 mb-1">M·∫≠t kh·∫©u Admin (*)</label>
            <input type="password" id="password" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500 outline-none" placeholder="Nh·∫≠p m·∫≠t kh·∫©u...">
        </div>

        <div id="contentAuto" class="space-y-4 max-w-md mx-auto">
            <p class="text-gray-500 text-sm text-center">H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông qu√©t 100 b√†i vi·∫øt m·ªõi nh·∫•t t·ª´ Blog.</p>
            <input type="hidden" id="blogUrl" value="https://timkhaithi.pmtl.site">
            <button onclick="startSync()" id="btnSync" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-bold py-3 rounded-lg transition duration-300 flex justify-center items-center">
                üîÑ B·∫Øt ƒê·∫ßu Qu√©t & C·∫≠p Nh·∫≠t
            </button>
            <div id="statusArea" class="mt-4 hidden">
                <div id="logs" class="bg-gray-900 text-green-400 text-xs p-4 rounded-lg h-64 overflow-y-auto font-mono whitespace-pre-wrap leading-relaxed"></div>
            </div>
        </div>

        <div id="contentManual" class="hidden space-y-4 max-w-md mx-auto">
            <div>
                <label class="block text-sm font-medium text-gray-700">URL B√†i Vi·∫øt</label>
                <input type="text" id="manualUrl" class="w-full px-3 py-2 border rounded-lg focus:ring-1 focus:ring-amber-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Ti√™u ƒê·ªÅ</label>
                <input type="text" id="manualTitle" class="w-full px-3 py-2 border rounded-lg focus:ring-1 focus:ring-amber-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">N·ªôi Dung</label>
                <textarea id="manualContent" rows="6" class="w-full px-3 py-2 border rounded-lg focus:ring-1 focus:ring-amber-500"></textarea>
            </div>
            <button onclick="manualAdd()" id="btnManual" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition duration-300 flex justify-center items-center">
                üíæ L∆∞u V√†o Database
            </button>
            </div>

        <div id="contentCheck" class="hidden space-y-4">
            <div class="flex justify-between items-center mb-4">
                <p class="text-sm text-gray-600">Danh s√°ch c√°c b√†i vi·∫øt m·ªõi nh·∫•t ƒë√£ ƒë∆∞·ª£c n·∫°p v√†o Supabase.</p>
                <button onclick="checkLatest()" class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold py-2 px-4 rounded transition">
                    üîÑ L√†m M·ªõi
                </button>
            </div>
            
            <div class="overflow-x-auto border rounded-lg">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ti√™u ƒê·ªÅ (Metadata)</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lo·∫°i</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ng√†y t·∫°o</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Link</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="bg-white divide-y divide-gray-200 text-sm">
                        <tr>
                            <td colspan="5" class="px-4 py-4 text-center text-gray-500">Ch∆∞a c√≥ d·ªØ li·ªáu. B·∫•m "L√†m M·ªõi" ƒë·ªÉ xem.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        const API_URL = "https://psv-tkt.onrender.com"; 

        function switchTab(tab) {
            // Reset style
            ['tabAuto', 'tabManual', 'tabCheck'].forEach(id => {
                document.getElementById(id).className = "flex-1 py-3 px-4 text-center text-gray-500 hover:text-amber-600 font-medium whitespace-nowrap cursor-pointer border-b-2 border-transparent";
            });
            ['contentAuto', 'contentManual', 'contentCheck'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });

            // Active Tab
            const activeClass = "flex-1 py-3 px-4 text-center text-amber-600 border-b-2 border-amber-600 font-bold whitespace-nowrap cursor-pointer";
            if (tab === 'auto') {
                document.getElementById('tabAuto').className = activeClass;
                document.getElementById('contentAuto').classList.remove('hidden');
            } else if (tab === 'manual') {
                document.getElementById('tabManual').className = activeClass;
                document.getElementById('contentManual').classList.remove('hidden');
                // Chuy·ªÉn log area sang tab manual n·∫øu c·∫ßn
                document.getElementById('contentManual').appendChild(document.getElementById('statusArea'));
            } else if (tab === 'check') {
                document.getElementById('tabCheck').className = activeClass;
                document.getElementById('contentCheck').classList.remove('hidden');
            }
        }

        function log(msg) {
            const logBox = document.getElementById('logs');
            document.getElementById('statusArea').classList.remove('hidden');
            logBox.innerHTML += msg; 
            logBox.scrollTop = logBox.scrollHeight;
        }

        // --- H√ÄM 1: ƒê·ªíNG B·ªò STREAMING ---
        async function startSync() {
            const pass = document.getElementById('password').value;
            const blogUrl = document.getElementById('blogUrl').value;
            if (!pass) return alert("Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u!");

            const btn = document.getElementById('btnSync');
            btn.disabled = true;
            btn.innerHTML = `‚è≥ ƒêang x·ª≠ l√Ω...`;
            document.getElementById('statusArea').classList.remove('hidden');
            document.getElementById('contentAuto').appendChild(document.getElementById('statusArea')); // Move log to Auto tab
            
            document.getElementById('logs').innerHTML = "> B·∫Øt ƒë·∫ßu...\n";

            try {
                const response = await fetch(`${API_URL}/api/admin/sync-blogger`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: pass, blogUrl: blogUrl })
                });
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    log(decoder.decode(value));
                }
            } catch (error) {
                log(`‚ùå L·ªói: ${error.message}\n`);
            } finally {
                btn.disabled = false;
                btn.innerHTML = "üîÑ B·∫Øt ƒê·∫ßu Qu√©t & C·∫≠p Nh·∫≠t";
            }
        }

        // --- H√ÄM 2: TH√äM TH·ª¶ C√îNG ---
        async function manualAdd() {
            const pass = document.getElementById('password').value;
            const url = document.getElementById('manualUrl').value;
            const title = document.getElementById('manualTitle').value;
            const content = document.getElementById('manualContent').value;

            if (!pass) return alert("Thi·∫øu m·∫≠t kh·∫©u!");
            if (!url || !title || !content) return alert("Thi·∫øu th√¥ng tin!");

            const btn = document.getElementById('btnManual');
            btn.disabled = true;
            btn.innerHTML = `‚è≥ ƒêang x·ª≠ l√Ω...`;
            
            document.getElementById('statusArea').classList.remove('hidden');
            document.getElementById('logs').innerHTML = `> ƒêang x·ª≠ l√Ω: ${title}...\n`;

            try {
                const response = await fetch(`${API_URL}/api/admin/manual-add`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: pass, url, title, content })
                });
                const data = await response.json();
                if (data.logs) data.logs.forEach(l => log(l + "\n"));
                log(response.ok ? "‚úÖ TH√ÄNH C√îNG!\n" : `‚ùå L·ªñI: ${data.error}\n`);
            } catch (error) {
                log(`‚ùå L·ªói m·∫°ng: ${error.message}\n`);
            } finally {
                btn.disabled = false;
                btn.innerHTML = "üíæ L∆∞u V√†o Database";
            }
        }

        // --- H√ÄM 3: KI·ªÇM TRA D·ªÆ LI·ªÜU (M·ªöI) ---
        async function checkLatest() {
            const pass = document.getElementById('password').value;
            if (!pass) return alert("Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ xem d·ªØ li·ªáu!");

            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = `<tr><td colspan="5" class="px-4 py-4 text-center"><div class="animate-spin inline-block w-5 h-5 border-2 border-amber-600 rounded-full border-t-transparent"></div> ƒêang t·∫£i...</td></tr>`;

            try {
                const response = await fetch(`${API_URL}/api/admin/check-latest`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: pass })
                });
                const res = await response.json();

                if (!response.ok) throw new Error(res.error);

                tbody.innerHTML = "";
                if (res.data.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="5" class="px-4 py-4 text-center text-gray-500">Database tr·ªëng!</td></tr>`;
                    return;
                }

                res.data.forEach(item => {
                    const title = item.metadata?.title || "Kh√¥ng c√≥ ti√™u ƒë·ªÅ";
                    const type = item.metadata?.type || "unknown";
                    const date = new Date(item.created_at).toLocaleString('vi-VN');
                    
                    const row = `
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-2 border-b text-gray-500">#${item.id}</td>
                            <td class="px-4 py-2 border-b font-medium text-gray-800">${title}</td>
                            <td class="px-4 py-2 border-b text-gray-600 text-xs">
                                <span class="px-2 py-1 rounded bg-gray-200">${type}</span>
                            </td>
                            <td class="px-4 py-2 border-b text-gray-500 text-xs">${date}</td>
                            <td class="px-4 py-2 border-b">
                                <a href="${item.url}" target="_blank" class="text-blue-600 hover:underline text-xs">Xem Link</a>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });

            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="5" class="px-4 py-4 text-center text-red-600">L·ªói: ${error.message}</td></tr>`;
            }
        }
    </script>
</body>
</html>
