<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quáº£n Trá»‹ ViÃªn - Äá»“ng Bá»™ Dá»¯ Liá»‡u</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-4xl">
        <h1 class="text-2xl font-bold text-gray-800 mb-2 text-center">âš™ï¸ Quáº£n LÃ½ Dá»¯ Liá»‡u AI</h1>
        
        <div class="flex border-b border-gray-200 mb-6 overflow-x-auto text-sm">
            <button onclick="switchTab('auto')" id="tabAuto" class="flex-1 py-3 px-2 text-center text-amber-600 border-b-2 border-amber-600 font-bold whitespace-nowrap">Äá»“ng Bá»™ Blogger</button>
            <button onclick="switchTab('manual')" id="tabManual" class="flex-1 py-3 px-2 text-center text-gray-500 hover:text-amber-600 font-medium whitespace-nowrap">ThÃªm Thá»§ CÃ´ng</button>
            <button onclick="switchTab('check')" id="tabCheck" class="flex-1 py-3 px-2 text-center text-gray-500 hover:text-amber-600 font-medium whitespace-nowrap">ğŸ‘ï¸ Kiá»ƒm Tra</button>
            <button onclick="switchTab('maintain')" id="tabMaintain" class="flex-1 py-3 px-2 text-center text-gray-500 hover:text-amber-600 font-medium whitespace-nowrap">ğŸ§¹ Báº£o TrÃ¬</button>
        </div>

        <div class="mb-4 max-w-md mx-auto">
            <label class="block text-sm font-medium text-gray-700 mb-1">Máº­t kháº©u Admin (*)</label>
            <input type="password" id="password" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500 outline-none" placeholder="Nháº­p máº­t kháº©u...">
        </div>

        <div id="contentAuto" class="space-y-4 max-w-md mx-auto">
            <p class="text-gray-500 text-sm text-center">Tá»± Ä‘á»™ng quÃ©t 100 bÃ i viáº¿t má»›i nháº¥t tá»« Blog.</p>
            <input type="hidden" id="blogUrl" value="https://timkhaithi.pmtl.site">
            <button onclick="startSync()" id="btnSync" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-bold py-3 rounded-lg transition duration-300 flex justify-center items-center">
                ğŸ”„ Báº¯t Äáº§u QuÃ©t & Cáº­p Nháº­t
            </button>
        </div>

        <div id="contentManual" class="hidden space-y-4 max-w-md mx-auto">
            <div><label class="block text-sm font-medium text-gray-700">URL</label><input type="text" id="manualUrl" class="w-full px-3 py-2 border rounded-lg focus:ring-1 focus:ring-amber-500"></div>
            <div><label class="block text-sm font-medium text-gray-700">TiÃªu Äá»</label><input type="text" id="manualTitle" class="w-full px-3 py-2 border rounded-lg focus:ring-1 focus:ring-amber-500"></div>
            <div><label class="block text-sm font-medium text-gray-700">Ná»™i Dung</label><textarea id="manualContent" rows="6" class="w-full px-3 py-2 border rounded-lg focus:ring-1 focus:ring-amber-500"></textarea></div>
            <button onclick="manualAdd()" id="btnManual" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition duration-300 flex justify-center items-center">ğŸ’¾ LÆ°u VÃ o Database</button>
        </div>

        <div id="contentCheck" class="hidden space-y-4">
            <div class="flex justify-between items-center mb-4">
                <p class="text-sm text-gray-600">Danh sÃ¡ch bÃ i má»›i nháº¥t.</p>
                <button onclick="checkLatest()" class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold py-2 px-4 rounded transition">ğŸ”„ LÃ m Má»›i</button>
            </div>
            <div class="overflow-x-auto border rounded-lg max-h-96 overflow-y-auto">
                <table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-4 py-3 text-left text-xs font-medium text-gray-500">ID</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500">TiÃªu Äá»</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500">NgÃ y táº¡o</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500">Link</th></tr></thead><tbody id="tableBody" class="bg-white divide-y divide-gray-200 text-sm"><tr><td colspan="4" class="px-4 py-4 text-center text-gray-500">ChÆ°a cÃ³ dá»¯ liá»‡u.</td></tr></tbody></table>
            </div>
        </div>

        <div id="contentMaintain" class="hidden space-y-4 max-w-md mx-auto">
            <div class="bg-red-50 border border-red-200 p-4 rounded-lg">
                <h3 class="text-red-800 font-bold mb-2">âš ï¸ QuÃ©t Link Cháº¿t (Deep Scan)</h3>
                <p class="text-sm text-red-600 mb-4">QuÃ©t toÃ n bá»™ Link. Náº¿u gáº·p lá»—i, há»‡ thá»‘ng sáº½ tá»± Ä‘á»™ng thá»­ láº¡i.</p>
                
                <div class="mb-4">
                    <label class="block text-sm font-bold text-gray-700 mb-1">Báº¯t Ä‘áº§u tá»« sá»‘ thá»© tá»±:</label>
                    <div class="flex gap-2">
                        <input type="number" id="startIndex" value="0" class="w-24 px-3 py-2 border rounded-lg focus:ring-1 focus:ring-red-500 text-center font-bold">
                        <span class="text-xs text-gray-500 flex items-center">(Nháº­p sá»‘ 3400 náº¿u láº§n trÆ°á»›c bá»‹ lá»—i á»Ÿ Ä‘Ã³)</span>
                    </div>
                </div>

                <div class="w-full bg-gray-200 rounded-full h-4 mb-4 hidden" id="progressContainer">
                    <div class="bg-green-600 h-4 rounded-full transition-all duration-300" style="width: 0%" id="progressBar"></div>
                </div>
                <p id="progressText" class="text-xs text-center font-mono mb-2 text-gray-600"></p>

                <button onclick="scanDeadLinks()" id="btnScan" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg transition duration-300 flex justify-center items-center">
                    ğŸ—‘ï¸ Báº¯t Äáº§u QuÃ©t
                </button>
            </div>
        </div>

        <div id="statusArea" class="mt-6 hidden">
            <h3 class="font-bold text-gray-700 mb-2">Nháº­t kÃ½ hoáº¡t Ä‘á»™ng:</h3>
            <div id="logs" class="bg-gray-900 text-green-400 text-xs p-4 rounded-lg h-64 overflow-y-auto font-mono whitespace-pre-wrap leading-relaxed"></div>
        </div>
    </div>

    <script>
        const API_URL = "https://psv-tkt.onrender.com"; 
        
        // --- HÃ€M NGá»¦ (Delay) ---
        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        function switchTab(tab) {
            const tabs = ['tabAuto', 'tabManual', 'tabCheck', 'tabMaintain'];
            const contents = ['contentAuto', 'contentManual', 'contentCheck', 'contentMaintain'];
            
            tabs.forEach(id => document.getElementById(id).className = "flex-1 py-3 px-2 text-center text-gray-500 hover:text-amber-600 font-medium whitespace-nowrap cursor-pointer border-b-2 border-transparent");
            contents.forEach(id => document.getElementById(id).classList.add('hidden'));

            const activeClass = "flex-1 py-3 px-2 text-center text-amber-600 border-b-2 border-amber-600 font-bold whitespace-nowrap cursor-pointer";
            
            if (tab === 'auto') { document.getElementById('tabAuto').className = activeClass; document.getElementById('contentAuto').classList.remove('hidden'); }
            else if (tab === 'manual') { document.getElementById('tabManual').className = activeClass; document.getElementById('contentManual').classList.remove('hidden'); }
            else if (tab === 'check') { document.getElementById('tabCheck').className = activeClass; document.getElementById('contentCheck').classList.remove('hidden'); }
            else if (tab === 'maintain') { document.getElementById('tabMaintain').className = activeClass; document.getElementById('contentMaintain').classList.remove('hidden'); }
        }

        function log(msg) {
            const logBox = document.getElementById('logs');
            document.getElementById('statusArea').classList.remove('hidden');
            logBox.innerHTML += msg; 
            logBox.scrollTop = logBox.scrollHeight;
        }

        async function streamRequest(url, body, btnId, defaultText) {
            const btn = document.getElementById(btnId);
            btn.disabled = true; btn.innerHTML = `â³ Äang cháº¡y...`;
            document.getElementById('statusArea').classList.remove('hidden');
            document.getElementById('logs').innerHTML = "> Khá»Ÿi Ä‘á»™ng...\n";

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    log(decoder.decode(value));
                }
            } catch (error) { log(`âŒ Lá»—i: ${error.message}\n`); }
            finally { btn.disabled = false; btn.innerHTML = defaultText; }
        }

        function startSync() {
            const pass = document.getElementById('password').value;
            const blogUrl = document.getElementById('blogUrl').value;
            if (!pass) return alert("Thiáº¿u máº­t kháº©u!");
            streamRequest(`${API_URL}/api/admin/sync-blogger`, { password: pass, blogUrl }, 'btnSync', 'ğŸ”„ Báº¯t Äáº§u QuÃ©t & Cáº­p Nháº­t');
        }

        // --- HÃ€M QUÃ‰T LINK CHáº¾T (ÄÃƒ NÃ‚NG Cáº¤P RETRY & RESUME) ---
        async function scanDeadLinks() {
            const pass = document.getElementById('password').value;
            // Láº¥y giÃ¡ trá»‹ báº¯t Ä‘áº§u tá»« Ã´ nháº­p (Máº·c Ä‘á»‹nh lÃ  0)
            const startIndex = parseInt(document.getElementById('startIndex').value) || 0;

            if (!pass) return alert("Thiáº¿u máº­t kháº©u!");
            if (!confirm(`Há»‡ thá»‘ng sáº½ báº¯t Ä‘áº§u quÃ©t tá»« sá»‘ thá»© tá»± ${startIndex}. Báº¡n cháº¯c chá»©?`)) return;

            const btn = document.getElementById('btnScan');
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');

            btn.disabled = true; btn.innerHTML = "â³ Äang táº£i danh sÃ¡ch...";
            progressContainer.classList.remove('hidden');
            document.getElementById('statusArea').classList.remove('hidden');
            const logBox = document.getElementById('logs');
            logBox.innerHTML = "> Äang táº£i toÃ n bá»™ danh sÃ¡ch URL tá»« Database...\n";

            try {
                // 1. Láº¥y toÃ n bá»™ URL
                const resList = await fetch(`${API_URL}/api/admin/get-all-urls`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ password: pass })
                });
                const dataList = await resList.json();
                
                if (!dataList.success) throw new Error(dataList.error);

                const totalUrls = dataList.urls.length;
                log(`âœ… ÄÃ£ táº£i xong: ${totalUrls} link.\n`);
                
                if (startIndex >= totalUrls) {
                    throw new Error("Sá»‘ báº¯t Ä‘áº§u lá»›n hÆ¡n tá»•ng sá»‘ link!");
                }

                log(`ğŸš€ Báº¯t Ä‘áº§u quÃ©t tá»« vá»‹ trÃ­ ${startIndex}...\n`);

                // 2. Chia nhá» vÃ  quÃ©t
                const batchSize = 20; 
                let deletedTotal = 0;
                
                // VÃ²ng láº·p báº¯t Ä‘áº§u tá»« vá»‹ trÃ­ startIndex
                for (let i = startIndex; i < totalUrls; i += batchSize) {
                    const batch = dataList.urls.slice(i, i + batchSize);
                    let success = false;
                    let retryCount = 0;

                    // CÆ¡ cháº¿ tá»± Ä‘á»™ng thá»­ láº¡i (Retry Loop)
                    while (!success && retryCount < 5) { // Thá»­ tá»‘i Ä‘a 5 láº§n
                        try {
                            const resCheck = await fetch(`${API_URL}/api/admin/check-batch`, {
                                method: 'POST', headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({ password: pass, urls: batch })
                            });

                            if (!resCheck.ok) throw new Error(`HTTP Error ${resCheck.status}`);

                            const dataCheck = await resCheck.json();

                            if (dataCheck.logs && dataCheck.logs.length > 0) {
                                dataCheck.logs.forEach(l => log(l + "\n"));
                            }
                            deletedTotal += dataCheck.deleted || 0;
                            success = true; // ThÃ nh cÃ´ng, thoÃ¡t vÃ²ng láº·p retry

                        } catch (err) {
                            retryCount++;
                            log(`âš ï¸ Lá»—i máº¡ng (Thá»­ láº¡i ${retryCount}/5): ${err.message}. Äá»£i 5s...\n`);
                            await sleep(5000); // Äá»£i 5 giÃ¢y rá»“i thá»­ láº¡i
                        }
                    }

                    if (!success) {
                        log(`âŒ QUÃ Sá» Láº¦N THá»¬ Láº I! Dá»«ng táº¡i vá»‹ trÃ­ ${i}. HÃ£y nháº­p ${i} vÃ o Ã´ "Báº¯t Ä‘áº§u tá»«" Ä‘á»ƒ cháº¡y tiáº¿p.\n`);
                        document.getElementById('startIndex').value = i; // Tá»± Ä‘iá»n sá»‘ cho láº§n sau
                        break; // Dá»«ng chÆ°Æ¡ng trÃ¬nh
                    }

                    // Cáº­p nháº­t tiáº¿n trÃ¬nh
                    const processed = Math.min(i + batchSize, totalUrls);
                    const percent = Math.min(100, Math.round((processed / totalUrls) * 100));
                    progressBar.style.width = `${percent}%`;
                    progressText.innerText = `Äang xá»­ lÃ½: ${processed}/${totalUrls} (${percent}%) - ÄÃ£ xÃ³a: ${deletedTotal}`;
                    
                    log(`> ÄÃ£ check ${processed}/${totalUrls}...\n`);
                }

                log(`\nğŸ‰ HOÃ€N Táº¤T PHIÃŠN LÃ€M VIá»†C! Tá»•ng sá»‘ link cháº¿t Ä‘Ã£ xÃ³a: ${deletedTotal}.\n`);

            } catch (error) {
                log(`âŒ Lá»—i: ${error.message}\n`);
            } finally {
                btn.disabled = false; btn.innerHTML = "ğŸ—‘ï¸ Báº¯t Äáº§u QuÃ©t";
            }
        }

        async function manualAdd() {
            const pass = document.getElementById('password').value;
            const url = document.getElementById('manualUrl').value;
            const title = document.getElementById('manualTitle').value;
            const content = document.getElementById('manualContent').value;
            if (!pass || !url || !title || !content) return alert("Thiáº¿u thÃ´ng tin!");
            
            const btn = document.getElementById('btnManual');
            btn.disabled = true; btn.innerHTML = "â³...";
            document.getElementById('statusArea').classList.remove('hidden');
            document.getElementById('logs').innerHTML = `> Äang xá»­ lÃ½ ${title}...\n`;
            
            try {
                const res = await fetch(`${API_URL}/api/admin/manual-add`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({password: pass, url, title, content})
                });
                const data = await res.json();
                if(data.logs) data.logs.forEach(l => log(l+"\n"));
                log(res.ok ? "âœ… XONG!\n" : `âŒ Lá»–I: ${data.error}\n`);
            } catch(e) { log(`âŒ ${e.message}`); }
            finally { btn.disabled = false; btn.innerHTML = "ğŸ’¾ LÆ°u VÃ o Database"; }
        }

        async function checkLatest() {
            const pass = document.getElementById('password').value;
            if (!pass) return alert("Thiáº¿u máº­t kháº©u!");
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4">Äang táº£i...</td></tr>`;
            try {
                const res = await fetch(`${API_URL}/api/admin/check-latest`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({password: pass})
                });
                const json = await res.json();
                if(!res.ok) throw new Error(json.error);
                tbody.innerHTML = "";
                if(json.data.length === 0) { tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4">Trá»‘ng</td></tr>`; return; }
                json.data.forEach(item => {
                    const date = item.created_at ? new Date(item.created_at).toLocaleString('vi-VN') : 'N/A';
                    tbody.innerHTML += `<tr class="hover:bg-gray-50"><td class="px-4 py-2 border-b text-gray-500">#${item.id}</td><td class="px-4 py-2 border-b font-bold text-gray-800">${item.metadata?.title || 'No Title'}</td><td class="px-4 py-2 border-b text-xs text-gray-500">${date}</td><td class="px-4 py-2 border-b"><a href="${item.url}" target="_blank" class="text-blue-600 hover:underline text-xs">Link</a></td></tr>`;
                });
            } catch (e) { tbody.innerHTML = `<tr><td colspan="4" class="text-center text-red-500 py-4">${e.message}</td></tr>`; }
        }
    </script>
</body>
</html>
